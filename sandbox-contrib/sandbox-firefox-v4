#!/bin/execlineb -s0
# Launch firefox with fewer permissions.
#
fdreserve 1
importas rundir XDG_RUNTIME_DIR

multisubstitute
{
	define   DBUS_PROXY ${rundir}/bus-proxy/firefox
	importas DBUS_HOST  DBUS_SESSION_BUS_ADDRESS
	importas READY_FD   FD0
}

background
{
	xdg-dbus-proxy --fd=${READY_FD} $DBUS_HOST $DBUS_PROXY
	--filter
	--broadcast=org.freedesktop.portal.*=@/org/freedesktop/portal/*
	--call=org.freedesktop.portal.*=*
	--own=org.mozilla.firefox.*
	--talk=ca.desrt.dconf
	--talk=org.pipewire.node
}

# Run firefox in a hardened prebuilt-container.
#
podman run
--network=host
--rm
--security-opt label=type:container_runtime_t
--userns=keep-id
-e DBUS_SESSION_BUS_ADDRESS=${DBUS_PROXY}
